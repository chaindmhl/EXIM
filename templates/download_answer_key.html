<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Answer Key | E-Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Poppins", Arial, sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-custom {
            background-color: #0d6efd;
            color: white;
            border-radius: 10px;
            padding: 10px 20px;
        }
        .btn-custom:hover {
            background-color: #0b5ed7;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="card p-4">
        <h3 class="text-center mb-4">üìò Download Answer Key</h3>
        <form id="download-form" class="row g-3">
            <!-- Board Exam / Course -->
            <div class="col-md-4">
                <label for="board_exam" class="form-label">Board Exam / Course</label>
                <select id="board_exam" name="board_exam" class="form-select" required>
                    <option value="">-- Select Board Exam / Course --</option>
                    {% for exam in board_exams %}
                        <option value="{{ exam }}">{{ exam }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Subject -->
            <div class="col-md-4">
                <label for="subject" class="form-label">Subject</label>
                <select id="subject" name="subject" class="form-select" required>
                    <option value="">-- Select Subject --</option>
                </select>
            </div>

            <!-- Topic -->
            <div class="col-md-4">
                <label for="topic" class="form-label">Topic</label>
                <select id="topic" name="topic" class="form-select" required>
                    <option value="">-- Select Topic --</option>
                </select>
            </div>

            <!-- Test Key -->
            <div class="col-md-6">
                <label for="testkey" class="form-label">Test Key</label>
                <select id="testkey" name="testkey" class="form-select" required>
                    <option value="">-- Select Test Key --</option>
                    {% for test in testkeys %}
                        <option value="{{ test.set_id }}">{{ test.set_id }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-custom w-100">‚¨áÔ∏è Download Answer Key</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const BOARD_EXAM_TOPICS = JSON.parse('{{ BOARD_EXAM_TOPICS_JSON|escapejs }}');

  // Populate subjects based on board exam
  $('#board_exam').on('change', function() {
      const exam = $(this).val();
      const subjects = BOARD_EXAM_TOPICS[exam] ? Object.keys(BOARD_EXAM_TOPICS[exam]) : [];
      $('#subject').empty().append('<option value="">-- Select Subject --</option>');
      subjects.forEach(subject => {
          $('#subject').append(`<option value="${subject}">${subject}</option>`);
      });
      $('#topic').empty().append('<option value="">-- Select Topic --</option>');
  });

  // Populate topics based on subject
  $('#subject').on('change', function() {
      const exam = $('#board_exam').val();
      const subject = $(this).val();
      const topics = BOARD_EXAM_TOPICS[exam] ? BOARD_EXAM_TOPICS[exam][subject] || [] : [];
      $('#topic').empty().append('<option value="">-- Select Topic --</option>');
      topics.forEach(topic => {
          $('#topic').append(`<option value="${topic}">${topic}</option>`);
      });
  });

  // Download Answer Key
  $('#download-form').submit(function(e) {
      e.preventDefault();
      const examId = $('#testkey').val();
      const boardExam = $('#board_exam').val();
      const subject = $('#subject').val();
      const topic = $('#topic').val();

      if (!examId || !boardExam || !subject || !topic) {
          alert("‚ö†Ô∏è Please complete all fields before downloading.");
          return;
      }

      window.location.href = "{% url 'download_answer_key' %}?exam_id=" + encodeURIComponent(examId);
  });
</script>
</body>
</html>
