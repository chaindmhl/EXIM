<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Import Questions | EXIM</title>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<style>
  body { font-family: "Poppins", Arial, sans-serif; background-color: #f4f6f8; color: #333; }
  .navbar { background-color: #1f2937; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 6px 0 !important; }
  .navbar-brand { font-weight: 600; color: #fff !important; font-size: 1.1rem; }
  .navbar-brand:hover { color: #10b981 !important; transform: scale(1.05); }
  .nav-link { color: #fff !important; font-size: 1rem; transition: color 0.3s; }
  .nav-link:hover { color: #10b981 !important; }
  h1 { text-align:center; margin:40px 0 20px; color:#1f2937; font-weight:600; }
  form { max-width:650px; margin:0 auto 60px; background-color:#fff; padding:30px 35px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.05); animation:fadeIn 0.5s ease-in-out; }
  label { font-weight:500; margin-bottom:6px; color:#1f2937; }
  select, input[type="file"], input[type="text"] { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:18px; font-size:15px; }
  button[type="submit"] { background-color:#10b981; color:#fff; border:none; padding:12px; width:100%; font-weight:500; border-radius:8px; transition: all 0.3s ease; }
  button[type="submit"]:hover { background-color:#059669; }
  small { display:block; margin-top:-12px; margin-bottom:18px; color:#6b7280; }
  code { background-color:#f3f4f6; padding:2px 6px; border-radius:4px; font-size:0.9rem; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
</style>

<script>
  const BOARD_EXAM_TOPICS = JSON.parse('{{ BOARD_EXAM_TOPICS_JSON|escapejs }}');

  function updateSubjects() {
    const course = document.getElementById("course").value;
    const subjectSelect = document.getElementById("subject");
    const topicSelect = document.getElementById("topic");

    subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
    topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';

    if (course && BOARD_EXAM_TOPICS[course]) {
      Object.keys(BOARD_EXAM_TOPICS[course]).forEach(subject => {
        subjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
      });
    }
  }

  function updateTopics() {
    const course = document.getElementById("course").value;
    const subject = document.getElementById("subject").value;
    const topicSelect = document.getElementById("topic");

    topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';

    if (course && subject && BOARD_EXAM_TOPICS[course][subject]) {
      BOARD_EXAM_TOPICS[course][subject].forEach(topic => {
        topicSelect.innerHTML += `<option value="${topic}">${topic}</option>`;
      });
    }
  }

  function toggleFileInput() {
    const course = document.getElementById("course").value;
    const subject = document.getElementById("subject").value;
    const topic = document.getElementById("topic").value;
    const fileInput = document.getElementById("folder_upload");

    fileInput.disabled = !(course && subject && topic);
  }

  function validateForm() {
    const course = document.getElementById("course").value.trim();
    const subject = document.getElementById("subject").value.trim();
    const topic = document.getElementById("topic").value.trim();
    const fileInput = document.getElementById("folder_upload");

    if (!course) { alert("Course is required!"); return false; }
    if (!subject) { alert("Subject is required!"); return false; }
    if (!topic) { alert("Topic is required!"); return false; }
    if (!fileInput.value) { alert("Please select a folder to upload."); return false; }
    return true;
  }

  document.addEventListener("DOMContentLoaded", () => {
    ["course","subject","topic"].forEach(id =>
      document.getElementById(id).addEventListener("change", toggleFileInput)
    );
    toggleFileInput();
  });
</script>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'home' %}">EXIM</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="{% url 'question_bank' %}">Question Bank</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<h1>Import Questions</h1>

<form id="uploadForm" action="{% url 'upload_file' %}" method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div>
    <label for="course">Board Exam / Course:</label>
    <select id="course" name="course" required onchange="updateSubjects()">
      <option value="">-- Select Course --</option>
      {% for course_name in BOARD_EXAMS %}
        <option value="{{ course_name }}">{{ course_name }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label for="subject">Subject:</label>
    <select id="subject" name="subject" required onchange="updateTopics()">
      <option value="">-- Select Subject --</option>
    </select>
  </div>

  <div>
    <label for="topic">Topic:</label>
    <select id="topic" name="topic" required>
      <option value="">-- Select Topic --</option>
    </select>
  </div>

  <div>
    <label for="folder_upload">Select Folder (with file + images):</label>
    <input type="file" id="folder_upload" name="folder_upload" webkitdirectory directory multiple required />
    <small>
      Upload a folder that contains your question file and related images.<br>
      <strong>Note:</strong> Images referenced in questions must match the filenames exactly.<br>
    </small>
  </div>

  <button id="uploadButton" type="submit">Upload Folder</button>

  <!-- PROGRESS BAR -->
  <div id="progressContainer" class="mt-4" style="display:none;">
    <label class="fw-bold">Uploading…</label>
    <div class="progress" style="height: 25px;">
      <div id="progressBar"
           class="progress-bar progress-bar-striped progress-bar-animated"
           style="width: 0%">0%</div>
    </div>
  </div>

</form>

<script>
  document.getElementById("uploadForm").addEventListener("submit", function(e){
      e.preventDefault(); // prevent normal submission
  
      if (!validateForm()) return;
  
      const btn = document.getElementById("uploadButton");
      btn.disabled = true;
      btn.innerText = "Uploading…";
  
      const container = document.getElementById("progressContainer");
      const bar = document.getElementById("progressBar");
      container.style.display = "block";
  
      const formData = new FormData();
  
      // Add all selected files
      const files = document.getElementById("folder_upload").files;
      for (let i = 0; i < files.length; i++) {
          formData.append("folder_upload", files[i]);
      }
  
      // Add CSRF token
      formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
  
      // Add course/subject/topic
      formData.append("course", document.getElementById("course").value);
      formData.append("subject", document.getElementById("subject").value);
      formData.append("topic", document.getElementById("topic").value);
  
      const xhr = new XMLHttpRequest();
      xhr.open("POST", this.action, true);
  
      xhr.upload.onprogress = function(e){
          if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              bar.style.width = percent + "%";
              bar.textContent = percent + "%";
          }
      };
  
      xhr.onload = function(){
          if (xhr.status === 200) {
              alert("✅ Questions imported successfully!");
              window.location.href = "{% url 'question_bank' %}"; // manual redirect
          } else {
              alert("❌ Upload failed: " + xhr.statusText);
              btn.disabled = false;
              btn.innerText = "Upload Folder";
          }
      };
  
      xhr.onerror = function(){
          alert("❌ Upload failed due to network error.");
          btn.disabled = false;
          btn.innerText = "Upload Folder";
      };
  
      xhr.send(formData);
  });
  </script>
  
  

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
