<!-- templates/practice_result.html -->
{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Practice Result</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="card p-4">
    <h3>Practice Result â€” {{ res.board_exam }}</h3>
    <p>Score: <strong>{{ res.score }}</strong> / {{ res.total_items }} ({{ res.percent|floatformat:2 }}%)</p>
    <p>Total time: <strong>{{ res.total_time|floatformat:2 }}</strong> seconds</p>

    <div class="row">
      <div class="col-md-6">
        <canvas id="correctChart"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="timeChart"></canvas>
      </div>
    </div>

    <hr/>
    <h5>Question breakdown</h5>
    <div>
        {% for r in res.results %}
        <div class="alert 
            {% if r.is_correct %}
            alert-success
            {% else %}
            alert-danger
            {% endif %}
        ">
            Question {{ r.index }}: {{ r.text }}<br>
            {% if r.image_url %}
            <img src="{{ r.image_url }}" alt="Question Image" style="max-width:300px; display:block; margin-top:10px; margin-bottom:10px;">
            {% endif %}
            Your Answer: {{ r.selected }} | Correct: {{ r.correct }} | Time: {{ r.time_spent }}s
        </div>
        {% endfor %}
    </div>

    <a href="{% url 'practice_start' %}" class="btn btn-primary mt-3">Take another practice</a>
    <a href="{% url 'home_student' %}" class="btn btn-primary mt-3">Go Back to Home</a>
  </div>
</div>

<script id="practice-results-data" type="application/json">
    {{ res.results|json_script:"practice-results" }}
</script>

<script>
  // prepare chart data
  const results = JSON.parse(document.getElementById('practice-results-data').textContent);
  const labels = results.map(r => 'Q' + r.index);
  const correctData = results.map(r => r.is_correct ? 1 : 0);
  const timeData = results.map(r => Number(r.time_spent) || 0);

  // Correct/wrong bar (count)
  new Chart(document.getElementById('correctChart'), {
    type: 'bar',
    data: {
      labels: ['Correct', 'Wrong'],
      datasets: [{
        label: 'Count',
        data: [ correctData.reduce((s,v)=>s+v,0), correctData.length - correctData.reduce((s,v)=>s+v,0) ],
        backgroundColor: ['#10B981','#EF4444']
      }]
    },
    options: { responsive: true }
  });

  // Time per question
  new Chart(document.getElementById('timeChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Time (s)',
        data: timeData,
        fill: false,
        tension: 0.2,
        borderColor: '#2563EB'
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
</body>
</html>
